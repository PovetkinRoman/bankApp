#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π ‚Üí –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./rebuild-and-deploy.sh [clean] [skip-tests] [services...]

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

log_docker() {
    echo -e "${CYAN}[DOCKER]${NC} $1"
}

# –í—Å–µ Docker —Å–µ—Ä–≤–∏—Å—ã
ALL_SERVICES=(
    "accounts-app"
    "blocker-app" 
    "cash-app"
    "exchange-app"
    "exchange-generator-app"
    "front-ui-app"
    "notifications-app"
    "transfer-app"
)

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
CLEAN_BUILD=false
SKIP_TESTS=false
SPECIFIC_SERVICES=()

for arg in "$@"; do
    case $arg in
        clean)
            CLEAN_BUILD=true
            ;;
        skip-tests)
            SKIP_TESTS=true
            ;;
        *-app)
            SPECIFIC_SERVICES+=("$arg")
            ;;
        *)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è –±–µ–∑ -app
            if [[ " ${ALL_SERVICES[@]} " =~ " ${arg}-app " ]]; then
                SPECIFIC_SERVICES+=("${arg}-app")
            else
                log_warning "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: $arg"
            fi
            ;;
    esac
done

# –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ
if [ ${#SPECIFIC_SERVICES[@]} -eq 0 ]; then
    SPECIFIC_SERVICES=("${ALL_SERVICES[@]}")
fi

echo "========================================"
log_step "üöÄ –ü–û–õ–ù–´–ô –¶–ò–ö–õ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø"
echo "========================================"
log_info "–°–µ—Ä–≤–∏—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${SPECIFIC_SERVICES[*]}"
echo

# –®–ê–ì 1: –°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π —á–µ—Ä–µ–∑ mvnw
echo "========================================"
log_step "1Ô∏è‚É£  –°–ë–û–†–ö–ê –ú–û–î–£–õ–ï–ô –ß–ï–†–ï–ó MVNW"
echo "========================================"

BUILD_ARGS=""
if [ "$CLEAN_BUILD" = true ]; then
    BUILD_ARGS="$BUILD_ARGS clean"
fi
if [ "$SKIP_TESTS" = true ]; then
    BUILD_ARGS="$BUILD_ARGS skip-tests"
fi

log_info "–ó–∞–ø—É—Å–∫–∞–µ–º: ./build-all.sh skip-tests"
if ./build-all.sh skip-tests; then
    log_success "‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!"
else
    log_error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –º–æ–¥—É–ª–µ–π. –û—Å—Ç–∞–Ω–æ–≤–∫–∞."
    exit 1
fi

echo

# –®–ê–ì 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "========================================"
log_step "2Ô∏è‚É£  –û–°–¢–ê–ù–û–í–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
echo "========================================"

log_docker "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: ${SPECIFIC_SERVICES[*]}"
if docker compose stop "${SPECIFIC_SERVICES[@]}" 2>/dev/null; then
    log_success "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    log_warning "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –±—ã–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
fi

echo

# –®–ê–ì 3: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
echo "========================================"
log_step "3Ô∏è‚É£  –ü–ï–†–ï–°–ë–û–†–ö–ê DOCKER –û–ë–†–ê–ó–û–í"
echo "========================================"

log_docker "–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤"
if docker compose build "${SPECIFIC_SERVICES[@]}"; then
    log_success "‚úÖ Docker –æ–±—Ä–∞–∑—ã –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã!"
else
    log_error "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–æ–≤"
    exit 1
fi

echo

# –®–ê–ì 4: –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "========================================"
log_step "4Ô∏è‚É£  –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ù–´–• –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
echo "========================================"

log_docker "–ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
if docker compose up -d "${SPECIFIC_SERVICES[@]}"; then
    log_success "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã!"
else
    log_error "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
    exit 1
fi

echo

# –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "========================================"
log_step "5Ô∏è‚É£  –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –°–ï–†–í–ò–°–û–í"
echo "========================================"

sleep 5  # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫

log_info "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
docker compose ps

echo

# –®–ê–ì 6: –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo "========================================"
log_step "üéâ –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "========================================"

log_success "–í—Å–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:"
echo "  ‚úÖ –ú–æ–¥—É–ª–∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ mvnw"
echo "  ‚úÖ Docker –æ–±—Ä–∞–∑—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
echo "  ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

echo
log_info "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "  üìã –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:    docker compose ps"
echo "  üìù –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞: docker compose logs <service-name>"
echo "  üîç –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:      docker compose logs"

echo
log_info "–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞:"
echo "  ./rebuild-and-deploy.sh                    # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
echo "  ./rebuild-and-deploy.sh skip-tests         # –ë—ã—Å—Ç—Ä–∞—è —Å–±–æ—Ä–∫–∞ –≤—Å–µ—Ö"
echo "  ./rebuild-and-deploy.sh cash accounts      # –¢–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã"
echo "  ./rebuild-and-deploy.sh clean skip-tests cash  # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ cash"
