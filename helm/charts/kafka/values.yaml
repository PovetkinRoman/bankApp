# Kafka KRaft mode configuration (без Zookeeper)

# Kafka configuration
kafka:
  image:
    repository: confluentinc/cp-kafka
    tag: "7.5.3"
    pullPolicy: IfNotPresent
  
  replicaCount: 1
  
  service:
    type: ClusterIP
    port: 9092
    targetPort: 9092
    # Дополнительный порт для контроллера
    controllerPort: 9093
  
  # KRaft configuration
  kraft:
    enabled: true
    # Cluster ID (должен быть уникальным UUID)
    # Генерируется автоматически при первом запуске
    clusterId: ""
    # Node ID для этого брокера
    nodeId: 1
    # Роли: broker, controller, или broker,controller (combined mode)
    processRoles: "broker,controller"
    # Quorum voters (для single node: 1@kafka:9093)
    quorumVoters: "1@kafka:9093"
  
  # Kafka broker configuration
  config:
    # Listeners для KRaft mode
    listeners: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
    advertisedListeners: "PLAINTEXT://kafka:9092"
    listenerSecurityProtocolMap: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
    controllerListenerNames: "CONTROLLER"
    
    # Topic defaults
    numPartitions: 3
    defaultReplicationFactor: 1
    minInsyncReplicas: 1
    
    # Log retention
    logRetentionHours: 168  # 7 days
    logRetentionBytes: 1073741824  # 1GB
    logSegmentBytes: 1073741824  # 1GB
    
    # Performance tuning
    numNetworkThreads: 3
    numIoThreads: 8
    socketSendBufferBytes: 102400
    socketReceiveBufferBytes: 102400
    socketRequestMaxBytes: 104857600
    
    # Group coordinator settings
    groupInitialRebalanceDelayMs: 0
    
    # Auto create topics
    autoCreateTopicsEnable: true
    
    # Offsets topic (для single node replication factor = 1)
    offsetsTopicReplicationFactor: 1
    transactionStateLogReplicationFactor: 1
    transactionStateLogMinIsr: 1
  
  # Persistent storage
  persistence:
    enabled: true
    storageClass: ""
    size: 10Gi
    mountPath: /var/lib/kafka/data
  
  # Resource limits (оптимизировано для single node)
  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi
  
  # Health checks
  livenessProbe:
    tcpSocket:
      port: 9092
    initialDelaySeconds: 30
    periodSeconds: 10
    failureThreshold: 3
  
  readinessProbe:
    tcpSocket:
      port: 9092
    initialDelaySeconds: 20
    periodSeconds: 5
    failureThreshold: 3

# Kafka topics to create automatically
topics:
  - name: account-events
    partitions: 3
    replicationFactor: 1
    config:
      retention.ms: "604800000"  # 7 days
      cleanup.policy: "delete"
  
  - name: transaction-events
    partitions: 3
    replicationFactor: 1
    config:
      retention.ms: "2592000000"  # 30 days
      cleanup.policy: "delete"
  
  - name: notification-events
    partitions: 3
    replicationFactor: 1
    config:
      retention.ms: "604800000"  # 7 days
      cleanup.policy: "delete"
  
  - name: audit-events
    partitions: 3
    replicationFactor: 1
    config:
      retention.ms: "7776000000"  # 90 days
      cleanup.policy: "delete"
  
  - name: exchange-rates
    partitions: 1
    replicationFactor: 1
    config:
      retention.ms: "86400000"  # 1 day
      cleanup.policy: "compact"

# Kafka Connect (optional)
connect:
  enabled: false
  image:
    repository: confluentinc/cp-kafka-connect
    tag: "7.5.3"
    pullPolicy: IfNotPresent
  
  replicaCount: 1
  
  service:
    type: ClusterIP
    port: 8083
    targetPort: 8083
  
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

# Schema Registry (optional)
schemaRegistry:
  enabled: false
  image:
    repository: confluentinc/cp-schema-registry
    tag: "7.5.3"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8081
    targetPort: 8081
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Kafka UI (для мониторинга)
kafkaUI:
  enabled: true
  image:
    repository: provectuslabs/kafka-ui
    tag: "latest"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8080
    targetPort: 8080
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
