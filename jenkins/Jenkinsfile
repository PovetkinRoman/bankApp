pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        DB_NAME         = 'bankapp'
        DB_USER         = 'root'
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_TEST  = 'test'
        NAMESPACE_PROD  = 'prod'
    }

    parameters {
        booleanParam(
            name: 'DEPLOY_INFRASTRUCTURE',
            defaultValue: true,
            description: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Kafka, Zipkin, Prometheus, Grafana, ELK)'
        )
        booleanParam(
            name: 'DEPLOY_APPLICATIONS',
            defaultValue: true,
            description: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è'
        )
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: scm.branches,
                    extensions: scm.extensions + [
                        [$class: 'CloneOption', timeout: 20, depth: 0, noTags: false, shallow: false]
                    ],
                    userRemoteConfigs: scm.userRemoteConfigs
                ])
            }
        }

        stage('Build & Unit Tests') {
            when {
                expression { params.RUN_TESTS }
            }
            parallel {
                stage('Front-ui service') {
                    steps {
                        dir('front-ui') {
                            sh './mvnw clean test'
                        }
                    }
                }
                stage('Accounts service') {
                    steps {
                        dir('accounts') {
                            sh './mvnw clean test'
                        }
                    }
                }
                stage('Cash service') {
                    steps {
                        dir('cash') {
                            sh './mvnw clean test'
                        }
                    }
                }
                stage('Transfer service') {
                    steps {
                        dir('transfer') {
                            sh './mvnw clean test'
                        }
                    }
                }
                stage('Exchange service') {
                    steps {
                        dir('exchange') {
                            sh './mvnw clean test'
                        }
                    }
                }
            }
        }

        stage('Build Docker Images') {
            when {
                expression { params.DEPLOY_APPLICATIONS }
            }
            steps {
                sh """
                echo "üê≥ Building Docker images..."
                docker build --no-cache -t bankapp/front-ui:${IMAGE_TAG} front-ui
                docker build --no-cache -t bankapp/accounts:${IMAGE_TAG} accounts
                docker build --no-cache -t bankapp/cash:${IMAGE_TAG} cash
                docker build --no-cache -t bankapp/transfer:${IMAGE_TAG} transfer
                docker build --no-cache -t bankapp/exchange:${IMAGE_TAG} exchange
                docker build --no-cache -t bankapp/exchange-generator:${IMAGE_TAG} exchange-generator
                docker build --no-cache -t bankapp/notifications:${IMAGE_TAG} notifications
                docker build --no-cache -t bankapp/blocker:${IMAGE_TAG} blocker
                """
            }
        }

        stage('Load Images to Minikube') {
            when {
                expression { params.DEPLOY_APPLICATIONS }
            }
            steps {
                sh """
                echo "üì¶ Loading images to Minikube..."
                minikube image load bankapp/front-ui:${IMAGE_TAG}
                minikube image load bankapp/accounts:${IMAGE_TAG}
                minikube image load bankapp/cash:${IMAGE_TAG}
                minikube image load bankapp/transfer:${IMAGE_TAG}
                minikube image load bankapp/exchange:${IMAGE_TAG}
                minikube image load bankapp/exchange-generator:${IMAGE_TAG}
                minikube image load bankapp/notifications:${IMAGE_TAG}
                minikube image load bankapp/blocker:${IMAGE_TAG}
                """
            }
        }

        stage('Deploy Infrastructure to TEST') {
            when {
                allOf {
                    branch 'dev'
                    expression { params.DEPLOY_INFRASTRUCTURE }
                }
            }
            parallel {
                stage('Deploy Kafka') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Kafka to TEST..."
                            kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install kafka helm/charts/kafka \\
                              --namespace ${NAMESPACE_TEST} \\
                              --set kafka.replicaCount=1 \\
                              --set kafkaUi.enabled=true \\
                              --wait --timeout=10m
                            
                            echo "‚úÖ Kafka deployed"
                        """
                    }
                }
                stage('Deploy Zipkin') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Zipkin to TEST..."
                            kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install zipkin helm/charts/zipkin \\
                              --namespace ${NAMESPACE_TEST} \\
                              --set image.tag=3.4.2 \\
                              --set storage.type=mem \\
                              --wait --timeout=5m
                            
                            echo "‚úÖ Zipkin deployed"
                        """
                    }
                }
                stage('Deploy Prometheus') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Prometheus to TEST..."
                            kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install prometheus helm/charts/prometheus \\
                              --namespace ${NAMESPACE_TEST} \\
                              --wait --timeout=5m
                            
                            echo "‚úÖ Prometheus deployed"
                        """
                    }
                }
                stage('Deploy Grafana') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Grafana to TEST..."
                            kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install grafana helm/charts/grafana \\
                              --namespace ${NAMESPACE_TEST} \\
                              --wait --timeout=5m
                            
                            echo "‚úÖ Grafana deployed"
                        """
                    }
                }
                stage('Deploy ELK Stack') {
                    steps {
                        sh """
                            echo "üöÄ Deploying ELK Stack to TEST..."
                            kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # Elasticsearch
                            helm upgrade --install elasticsearch helm/charts/elasticsearch \\
                              --namespace ${NAMESPACE_TEST} \\
                              --wait --timeout=10m
                            
                            # Logstash
                            helm upgrade --install logstash helm/charts/logstash \\
                              --namespace ${NAMESPACE_TEST} \\
                              --wait --timeout=5m
                            
                            # Kibana
                            helm upgrade --install kibana helm/charts/kibana \\
                              --namespace ${NAMESPACE_TEST} \\
                              --wait --timeout=5m
                            
                            echo "‚úÖ ELK Stack deployed"
                        """
                    }
                }
            }
        }

        stage('Verify Infrastructure TEST') {
            when {
                allOf {
                    branch 'dev'
                    expression { params.DEPLOY_INFRASTRUCTURE }
                }
            }
            steps {
                sh """
                    echo "üîç Verifying infrastructure in TEST..."
                    
                    # Kafka
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kafka -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Kafka not ready"
                    
                    # Zipkin
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=zipkin -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Zipkin not ready"
                    
                    # Prometheus
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Prometheus not ready"
                    
                    # Grafana
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Grafana not ready"
                    
                    # Elasticsearch
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=elasticsearch -n ${NAMESPACE_TEST} --timeout=600s || echo "‚ö†Ô∏è  Elasticsearch not ready"
                    
                    echo "‚úÖ Infrastructure verification completed"
                """
            }
        }


        stage('Deploy Applications to TEST') {
            when {
                allOf {
                    branch 'dev'
                    expression { params.DEPLOY_APPLICATIONS }
                }
            }
            steps {
                sh """
                    echo "üöÄ Deploying BankApp to TEST using Helm umbrella chart..."
                    
                    kubectl create namespace ${NAMESPACE_TEST} --dry-run=client -o yaml | kubectl apply -f -
                    
                    helm upgrade --install bankapp helm/ \\
                      --namespace ${NAMESPACE_TEST} \\
                      --set front-ui.image.tag=${IMAGE_TAG} \\
                      --set accounts.image.tag=${IMAGE_TAG} \\
                      --set cash.image.tag=${IMAGE_TAG} \\
                      --set transfer.image.tag=${IMAGE_TAG} \\
                      --set exchange.image.tag=${IMAGE_TAG} \\
                      --set exchange-generator.image.tag=${IMAGE_TAG} \\
                      --set notifications.image.tag=${IMAGE_TAG} \\
                      --set blocker.image.tag=${IMAGE_TAG} \\
                      --set front-ui.image.pullPolicy=Never \\
                      --set accounts.image.pullPolicy=Never \\
                      --set cash.image.pullPolicy=Never \\
                      --set transfer.image.pullPolicy=Never \\
                      --set exchange.image.pullPolicy=Never \\
                      --set exchange-generator.image.pullPolicy=Never \\
                      --set notifications.image.pullPolicy=Never \\
                      --set blocker.image.pullPolicy=Never \\
                      --wait --timeout=15m
                    
                    echo "‚úÖ BankApp deployed to TEST"
                """
            }
        }

        stage('Verify Applications TEST') {
            when {
                allOf {
                    branch 'dev'
                    expression { params.DEPLOY_APPLICATIONS }
                }
            }
            steps {
                sh """
                    echo "üîç Verifying applications in TEST..."
                    
                    # PostgreSQL
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  PostgreSQL not ready"
                    
                    # Keycloak
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=keycloak -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Keycloak not ready"
                    
                    # Front-UI
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=front-ui -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Front-UI not ready"
                    
                    # Accounts
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=accounts -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Accounts not ready"
                    
                    # Cash
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cash -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Cash not ready"
                    
                    # Transfer
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=transfer -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Transfer not ready"
                    
                    # Exchange
                    kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=exchange -n ${NAMESPACE_TEST} --timeout=300s || echo "‚ö†Ô∏è  Exchange not ready"
                    
                    echo "‚úÖ Applications verification completed"
                    
                    # Show all pods
                    echo ""
                    echo "üì¶ All pods in TEST:"
                    kubectl get pods -n ${NAMESPACE_TEST}
                """
            }
        }

        stage('Start Port Forwarding TEST') {
            when {
                allOf {
                    branch 'dev'
                    expression { params.DEPLOY_APPLICATIONS || params.DEPLOY_INFRASTRUCTURE }
                }
            }
            steps {
                sh """
                    echo "üîå Starting port-forward for TEST environment..."
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç port-forward –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
                    if [ -f "start-port-forward.sh" ]; then
                        bash start-port-forward.sh &
                        echo "‚úÖ Port forwarding started"
                        echo "üåê Access points:"
                        echo "   - Front-UI: http://localhost:8080"
                        echo "   - Keycloak: http://localhost:8090"
                        echo "   - Zipkin: http://localhost:9411"
                        echo "   - Prometheus: http://localhost:9090"
                        echo "   - Grafana: http://localhost:3000"
                        echo "   - Kibana: http://localhost:5601"
                        echo "   - Kafka UI: http://localhost:8085"
                    else
                        echo "‚ö†Ô∏è  start-port-forward.sh not found"
                    fi
                """
            }
        }

        stage('Manual Approval for PROD') {
            when {
                allOf {
                    branch 'main'
                    expression { params.DEPLOY_INFRASTRUCTURE || params.DEPLOY_APPLICATIONS }
                }
            }
            steps {
                script {
                    echo "üîî –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è –≤ PRODUCTION"
                    echo "üéØ Namespace: ${NAMESPACE_PROD}"
                    echo "üì¶ Image Tag: ${IMAGE_TAG}"
                    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ production –æ–∫—Ä—É–∂–µ–Ω–∏–µ!"
                }
                input message: 'Deploy to PROD environment?', ok: 'Yes, deploy to PROD'
            }
        }

        stage('Deploy Infrastructure to PROD') {
            when {
                allOf {
                    branch 'main'
                    expression { params.DEPLOY_INFRASTRUCTURE }
                }
            }
            parallel {
                stage('Deploy Kafka PROD') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Kafka to PROD..."
                            kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install kafka helm/charts/kafka \\
                              --namespace ${NAMESPACE_PROD} \\
                              --set kafka.replicaCount=3 \\
                              --set kafkaUi.enabled=true \\
                              --set kafka.resources.limits.cpu=2000m \\
                              --set kafka.resources.limits.memory=4Gi \\
                              --wait --timeout=15m
                            
                            echo "‚úÖ Kafka deployed to PROD"
                        """
                    }
                }
                stage('Deploy Zipkin PROD') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Zipkin to PROD..."
                            kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install zipkin helm/charts/zipkin \\
                              --namespace ${NAMESPACE_PROD} \\
                              --set image.tag=3.4.2 \\
                              --set storage.type=elasticsearch \\
                              --set storage.elasticsearch.hosts=http://bankapp-elasticsearch:9200 \\
                              --set resources.limits.memory=2Gi \\
                              --set resources.limits.cpu=1000m \\
                              --wait --timeout=10m
                            
                            echo "‚úÖ Zipkin deployed to PROD"
                        """
                    }
                }
                stage('Deploy Prometheus PROD') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Prometheus to PROD..."
                            kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install prometheus helm/charts/prometheus \\
                              --namespace ${NAMESPACE_PROD} \\
                              --set storage.size=50Gi \\
                              --set retention=30d \\
                              --wait --timeout=10m
                            
                            echo "‚úÖ Prometheus deployed to PROD"
                        """
                    }
                }
                stage('Deploy Grafana PROD') {
                    steps {
                        sh """
                            echo "üöÄ Deploying Grafana to PROD..."
                            kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                            
                            helm upgrade --install grafana helm/charts/grafana \\
                              --namespace ${NAMESPACE_PROD} \\
                              --wait --timeout=10m
                            
                            echo "‚úÖ Grafana deployed to PROD"
                        """
                    }
                }
                stage('Deploy ELK Stack PROD') {
                    steps {
                        sh """
                            echo "üöÄ Deploying ELK Stack to PROD..."
                            kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # Elasticsearch
                            helm upgrade --install elasticsearch helm/charts/elasticsearch \\
                              --namespace ${NAMESPACE_PROD} \\
                              --set persistence.size=100Gi \\
                              --wait --timeout=15m
                            
                            # Logstash
                            helm upgrade --install logstash helm/charts/logstash \\
                              --namespace ${NAMESPACE_PROD} \\
                              --wait --timeout=10m
                            
                            # Kibana
                            helm upgrade --install kibana helm/charts/kibana \\
                              --namespace ${NAMESPACE_PROD} \\
                              --wait --timeout=10m
                            
                            echo "‚úÖ ELK Stack deployed to PROD"
                        """
                    }
                }
            }
        }

        stage('Deploy Applications to PROD') {
            when {
                allOf {
                    branch 'main'
                    expression { params.DEPLOY_APPLICATIONS }
                }
            }
            steps {
                sh """
                    echo "üöÄ Deploying BankApp to PROD using Helm umbrella chart..."
                    
                    kubectl create namespace ${NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -
                    
                    helm upgrade --install bankapp helm/ \\
                      --namespace ${NAMESPACE_PROD} \\
                      --set front-ui.image.tag=${IMAGE_TAG} \\
                      --set accounts.image.tag=${IMAGE_TAG} \\
                      --set cash.image.tag=${IMAGE_TAG} \\
                      --set transfer.image.tag=${IMAGE_TAG} \\
                      --set exchange.image.tag=${IMAGE_TAG} \\
                      --set exchange-generator.image.tag=${IMAGE_TAG} \\
                      --set notifications.image.tag=${IMAGE_TAG} \\
                      --set blocker.image.tag=${IMAGE_TAG} \\
                      --set front-ui.image.pullPolicy=Never \\
                      --set accounts.image.pullPolicy=Never \\
                      --set cash.image.pullPolicy=Never \\
                      --set transfer.image.pullPolicy=Never \\
                      --set exchange.image.pullPolicy=Never \\
                      --set exchange-generator.image.pullPolicy=Never \\
                      --set notifications.image.pullPolicy=Never \\
                      --set blocker.image.pullPolicy=Never \\
                      --set postgresql.resources.limits.memory=2Gi \\
                      --set postgresql.resources.limits.cpu=1000m \\
                      --set keycloak.resources.limits.memory=2Gi \\
                      --set keycloak.resources.limits.cpu=2000m \\
                      --wait --timeout=20m
                    
                    echo "‚úÖ BankApp deployed to PROD"
                """
            }
        }

        stage('Verify Deployment PROD') {
            when {
                allOf {
                    branch 'main'
                    expression { params.DEPLOY_APPLICATIONS || params.DEPLOY_INFRASTRUCTURE }
                }
            }
            steps {
                sh """
                    echo "üîç Verifying deployment in PROD..."
                    
                    echo "üì¶ All pods in PROD:"
                    kubectl get pods -n ${NAMESPACE_PROD}
                    
                    echo ""
                    echo "üîå All services in PROD:"
                    kubectl get svc -n ${NAMESPACE_PROD}
                    
                    echo ""
                    echo "‚úÖ PROD deployment verification completed"
                """
            }
        }
    }

    post {
        success {
            script {
                def namespace = env.BRANCH_NAME == 'main' ? NAMESPACE_PROD : NAMESPACE_TEST
                echo "‚úÖ Pipeline —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
                echo "üéØ Namespace: ${namespace}"
                echo "üì¶ Image Tag: ${IMAGE_TAG}"
                
                if (params.DEPLOY_INFRASTRUCTURE) {
                    echo ""
                    echo "üèóÔ∏è  Infrastructure deployed:"
                    echo "   - Kafka (with UI)"
                    echo "   - Zipkin (Distributed Tracing)"
                    echo "   - Prometheus (Metrics)"
                    echo "   - Grafana (Dashboards)"
                    echo "   - ELK Stack (Logging)"
                }
                
                if (params.DEPLOY_APPLICATIONS) {
                    echo ""
                    echo "üöÄ Applications deployed:"
                    echo "   - PostgreSQL"
                    echo "   - Keycloak"
                    echo "   - Front-UI"
                    echo "   - Accounts"
                    echo "   - Cash"
                    echo "   - Transfer"
                    echo "   - Exchange"
                    echo "   - Exchange-Generator"
                    echo "   - Notifications"
                    echo "   - Blocker"
                }
                
                echo ""
                echo "üåê Access URLs (–ø–æ—Å–ª–µ port-forward):"
                echo "   - Front-UI: http://localhost:8080"
                echo "   - Keycloak: http://localhost:8090"
                echo "   - Zipkin: http://localhost:9411"
                echo "   - Prometheus: http://localhost:9090"
                echo "   - Grafana: http://localhost:3000 (admin/admin)"
                echo "   - Kibana: http://localhost:5601"
                echo "   - Kafka UI: http://localhost:8085"
            }
        }
        failure {
            echo "‚ùå Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
            echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Console Output –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
            echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Minikube –∑–∞–ø—É—â–µ–Ω –∏ –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤"
        }
        always {
            echo "üèÅ Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω"
        }
    }
}