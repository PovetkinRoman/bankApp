<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>–ö–æ—Ä–∑–∏–Ω–∞ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <script language="JavaScript">
        setInterval(() => {
            var td = document.getElementById('exchange_rates');
            fetch('http://localhost:8080/api/rates')
                .then(response => response.json())
                .then(json => {
                    var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                    table += '<tr><th colspan="3">–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ —Ä—É–±–ª—é</th></tr>';
                    table += '<tr><th>–í–∞–ª—é—Ç–∞</th><th>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ</th><th>–ö—É—Ä—Å</th></tr>';
                    json.forEach(rate => {
                        table += '<tr>';
                        table += '<td>' + rate.title + '</td>';
                        table += '<td>' + rate.name + '</td>';
                        table += '<td>' + rate.value + '</td>';
                        table += '</tr>';
                    });
                    table += '</table>';
                    td.innerHTML = table;
                })
                .catch(error => td.innerHTML = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç');
        }, 1000);
    </script>
</head>

<body>
<div style="float:right;">
    <span sec:authentication="name" style="margin-right: 10px;"></span>
    <form th:action="@{/logout}" method="post" style="display: inline;">
        <button type="submit" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">
            <b>–í–´–ô–¢–ò &cudarrr;</b>
        </button>
    </form>
</div>
<br>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/editPassword'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr>
                <td style="font-weight:bold;">–õ–æ–≥–∏–Ω</td>
                <td colspan="2" th:text="${login}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</td>
                <td>
                    <p style="color:green;" th:if="${passwordSuccess!=null}" th:text="${passwordSuccess}"/>
                    <p style="color:red;" th:if="${passwordErrors!=null}" th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>
                    <p>
                        –ü–∞—Ä–æ–ª—å: <input name="password" type="password" required/>
                    </p>
                    <p>
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å: <input name="confirm_password" type="password" required/>
                    </p>
                </td>
                <td style="text-align:right">
                    <button>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </td>
            </tr>
        </table>
        </form>
    </td>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/editUserAccounts'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr th:if="${userAccountsSuccess!=null}">
                <td colspan="3" style="color:green;" th:text="${userAccountsSuccess}"/>
            </tr>
            <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                <td colspan="3" style="color:red;" th:text="${userAccountsError}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è</td>
                <td th:text="${name != null && !#strings.isEmpty(name) ? name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}"/>
                <td>
                    <input name="name" type="text" style="width:100%" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"/>
                </td>
            </tr>
            <tr>
                <td style="font-weight:bold;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</td>
                <td th:text="${birthdate}"/>
                <td>
                    <input name="birthdate" type="date" style="width:100%"/>
                </td>
            </tr>
            <tr th:each="account : ${accounts}">
                <td style="font-weight:bold;" th:text="${account.getCurrency().getTitle()}"/>
                <td th:text="${account.isExists() ? (account.getValue()+' '+account.getCurrency().name()) : '–°—á–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω'}"/>
                <td style="text-align:right">
                    <input name="account" type="checkbox" th:checked="${account.isExists()}" th:value="${account.getCurrency().name()}" th:disabled="${account.isExists()}"/>
                </td>
            </tr>
            <tr>
                <td style="text-align:right" colspan="3">
                    <button>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                </td>
            </tr>
        </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/cash'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${cashSuccess!=null}">
                    <td colspan="4" style="color:green;" th:text="${cashSuccess}"/>
                </tr>
                <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                    <td colspan="4" style="color:red;" th:text="${cashError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">–ù–∞–ª–∏—á–Ω—ã–µ</td>
                    <td>
                        –í–∞–ª—é—Ç–∞
                        <select name="currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</option>
                            <option th:each="cashCurrency : ${cashCurrencies}" 
                                    th:value="${cashCurrency.currency.name()}" 
                                    th:text="${cashCurrency.currency.title + ' (' + cashCurrency.balance + ' ' + cashCurrency.currency.name() + ')'}"/>
                        </select>
                    </td>
                    <td>
                        –°—É–º–º–∞:
                        <input name="amount" type="number" min="0.01" step="0.01" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <button name="operation" value="deposit" type="submit">–ü–æ–ª–æ–∂–∏—Ç—å</button>
                        <button name="operation" value="withdraw" type="submit">–°–Ω—è—Ç—å</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferSuccess!=null}">
                    <td colspan="5" style="color:green;" th:text="${transferSuccess}"/>
                </tr>
                <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                    <td colspan="5" style="color:red;" th:text="${transferError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">–ü–µ—Ä–µ–≤–æ–¥ —Å–µ–±–µ</td>
                    <td>
                        –°–æ —Å—á–µ—Ç–∞
                        <select name="from_currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                            <option th:each="account : ${transferAccounts}" 
                                    th:value="${account.currency.name()}" 
                                    th:text="${account.currency.title + ' (' + account.balance + ' ' + account.currency.name() + ')'}"/>
                        </select>
                    </td>
                    <td>
                        –ù–∞ —Å—á–µ—Ç
                        <select name="to_currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                            <option th:each="account : ${transferAccounts}" 
                                    th:value="${account.currency.name()}" 
                                    th:text="${account.currency.title + ' (' + account.balance + ' ' + account.currency.name() + ')'}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="to_login" th:value="${login}"/>
                        <button>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/user/'+login+'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                    <td style="color:red;" th:text="${transferOtherError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">–ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥–æ–º—É</td>
                    <td>
                        –°–æ —Å—á–µ—Ç–∞
                        <select name="from_currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                            <option th:each="account : ${transferAccounts}" 
                                    th:value="${account.currency.name()}" 
                                    th:text="${account.currency.title + ' (' + account.balance + ' ' + account.currency.name() + ')'}"/>
                        </select>
                    </td>
                    <td>
                        –ù–∞ —Å—á–µ—Ç
                        <select name="to_currency" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É</option>
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" required/>
                    </td>
                    <td>
                        –ö–æ–º—É
                        <select name="to_login" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>
                            <option th:each="user : ${users}" th:value="${user.getLogin()}" th:text="${user.getName()}"/>
                        </select>
                    </td>
                    <td style="text-align:right">
                        <button>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;" id="exchange_rates">
    </td></tr>
</table>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö -->
<div id="email-notification-info" style="position: fixed; top: 20px; right: 20px; width: 300px; z-index: 1000; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h6 style="margin: 0; color: #495057;">üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h6>
        <button onclick="closeEmailNotificationInfo()" 
                style="background: none; border: none; color: #6c757d; cursor: pointer; font-size: 18px; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;"
                title="–ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">
            √ó
        </button>
    </div>
    <p style="margin: 0; font-size: 14px; color: #6c757d;">
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–∞—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ email –∞–¥—Ä–µ—Å, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –∞–∫–∫–∞—É–Ω—Ç—É.
        –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ email –æ—Ç–ø—Ä–∞–≤–∫–∏.
    </p>
</div>

<script>
function closeEmailNotificationInfo() {
    const infoDiv = document.getElementById('email-notification-info');
    if (infoDiv) {
        infoDiv.style.display = 'none';
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏
        localStorage.setItem('emailNotificationInfoClosed', 'true');
    }
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –±—ã–ª–æ –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ
document.addEventListener('DOMContentLoaded', function() {
    const wasClosed = localStorage.getItem('emailNotificationInfoClosed');
    if (wasClosed === 'true') {
        const infoDiv = document.getElementById('email-notification-info');
        if (infoDiv) {
            infoDiv.style.display = 'none';
        }
    }
});
</script>

</body>

</html>
